-- Select case report that occurred on 2018-01-15 in SQL City
SELECT * 
FROM crime_scene_report 
WHERE date = 20180115 AND city = 'SQL City';

-- Find witnesses and interview them 
SELECT * 
FROM interview 
JOIN person 
ON interview.person_id = person.id 
WHERE person.address_street_name = 'Northwestern Dr';
-- CLUES: man. gym member. membership number 48Z%. gold member. carplate: %H42W%

SELECT * 
FROM interview 
JOIN person 
ON interview.person_id = person.id 
WHERE person.name LIKE '%Annabel%' AND person.address_street_name = 'Franklin Ave';
-- CLUES: gym member. checked in on 20180109

SELECT m.name
FROM get_fit_now_member m
JOIN get_fit_now_check_in c
ON m.id = c.membership_id 
WHERE check_in_date = 20180109 AND membership_status = 'gold' AND membership_id LIKE '48Z%';

-- suspects down to: Joe Germuska, Jeremy Bowers


-- Let's group them in a WITH clause to tidy up 
WITH gym AS (
  SELECT name, person_id
  FROM get_fit_now_member 
  JOIN get_fit_now_check_in 
  ON get_fit_now_member.id = get_fit_now_check_in.membership_id 
  WHERE get_fit_now_check_in.check_in_date = 20180109 AND get_fit_now_member.membership_status = 'gold' AND get_fit_now_check_in.membership_id LIKE '48Z%'
  -- suspects down to: Joe Germuska, Jeremy Bowers
), car AS (
  SELECT name, person.id
  FROM person 
  JOIN drivers_license 
  ON person.license_id = drivers_license.id 
  WHERE drivers_license.gender = 'male' AND drivers_license.plate_number LIKE '%H42W%'
  -- -- suspects down to: Tushar Chandra, Jeremy Bowers
)

-- Find the culprit aka the common name that appears in both tables
SELECT *
FROM gym 
INNER JOIN car 
ON gym.person_id = car.id;
-- Culprit: Jeremy Bowers

-- Check solution for culprit
INSERT INTO solution VALUES (1, 'Jeremy Bowers');
SELECT value FROM solution;

-- Interview the culprit 
SELECT transcript 
FROM interview 
WHERE person_id = 67318;

-- CLUES: woman. rich. 5'5(65") or 5'7(67"). red hair. tesla model s. attended SQL symphony concert 3x in dec 2017.
SELECT p.name, dl.hair_color, dl.gender, dl.car_make, dl.car_model, dl.height 
FROM drivers_license dl
JOIN person p 
ON dl.id = p.license_id
JOIN facebook_event_checkin f
ON p.id = f.person_id 
WHERE dl.hair_color='red' AND dl.gender = 'female' AND dl.car_make='Tesla' AND dl.car_model='Model S' AND f.date LIKE '201712%';
-- Real villain: Miranda Priestly

-- Check solution for real villain
INSERT INTO solution VALUES (1, 'Miranda Priestly');
SELECT value FROM solution;
